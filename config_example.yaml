# Moat Configuration File
# This file contains all configuration options for the Moat reverse proxy
#
# Environment Variable Overrides:
# All configuration options can be overridden using environment variables with the AX_ prefix.
# For example: AX_SERVER_UPSTREAM=http://localhost:8080
#
# Available environment variables:
# - AX_SERVER_HTTP_ADDR, AX_SERVER_TLS_ADDR, AX_SERVER_UPSTREAM
# - AX_SERVER_HTTP_BIND, AX_SERVER_TLS_BIND (comma-separated)
# - AX_SERVER_HEALTH_CHECK_ENABLED, AX_SERVER_HEALTH_CHECK_ENDPOINT, AX_SERVER_HEALTH_CHECK_PORT
# - AX_SERVER_HEALTH_CHECK_METHODS, AX_SERVER_HEALTH_CHECK_ALLOWED_CIDRS (comma-separated)
# - AX_TLS_MODE, AX_TLS_ONLY, AX_TLS_CERT_PATH, AX_TLS_KEY_PATH
# - AX_ACME_DOMAINS, AX_ACME_CONTACTS (comma-separated)
# - AX_ACME_USE_PROD, AX_ACME_DIRECTORY, AX_ACME_ACCEPT_TOS, AX_ACME_CA_ROOT
# - AX_REDIS_URL, AX_REDIS_PREFIX
# - AX_NETWORK_IFACE, AX_NETWORK_IFACES (comma-separated), AX_NETWORK_DISABLE_XDP
# - AX_ARXIGNIS_API_KEY, AX_ARXIGNIS_BASE_URL, AX_ARXIGNIS_LOG_SENDING_ENABLED, AX_ARXIGNIS_INCLUDE_RESPONSE_BODY, AX_ARXIGNIS_MAX_BODY_SIZE
# - AX_DOMAINS_WHITELIST (comma-separated)
# - AX_LOGGING_LEVEL
# - AX_CAPTCHA_SITE_KEY, AX_CAPTCHA_SECRET_KEY, AX_CAPTCHA_JWT_SECRET
# - AX_CAPTCHA_PROVIDER, AX_CAPTCHA_TOKEN_TTL, AX_CAPTCHA_CACHE_TTL

# Redis Configuration
redis:
  # Redis connection URL for ACME cache storage
  url: "redis://127.0.0.1/0"

  # Namespace prefix for Redis ACME cache entries
  prefix: "ax:moat"

  # Redis SSL/TLS configuration (optional)
  # ssl:
  #   # Path to CA certificate file (PEM format)
  #   ca_cert_path: "/path/to/ca.crt"
  #   # Path to client certificate file (PEM format, optional, for mutual TLS)
  #   client_cert_path: "/path/to/client.crt"
  #   # Path to client private key file (PEM format, optional, for mutual TLS)
  #   client_key_path: "/path/to/client.key"
  #   # Skip certificate verification (for testing with self-signed certs)
  #   insecure: false

# Network Configuration
network:
  # The network interface to attach the XDP program to
  iface: "eth0"

  # Additional network interfaces for XDP attach (overrides iface if set)
  ifaces: []

  # Disable XDP packet filtering (run without BPF/XDP)
  disable_xdp: false

# Arxignis Configuration
arxignis:
  # API key for Arxignis service
  api_key: ""

  # Base URL for Arxignis API
  base_url: "https://api.arxignis.com/v1"

  # Enable sending access logs to arxignis server
  log_sending_enabled: true

  # Include response body in access logs
  include_response_body: true

  # Maximum size for request/response bodies in access logs (bytes) - Don't override in Basic plan that's the maximum allowed by the plan.
  max_body_size: 1048576

  # Captcha Configuration
  captcha:
    # Captcha site key for security verification
    site_key: null

    # Captcha secret key for security verification
    secret_key: null

    # JWT secret key for captcha token signing - openssl rand -base64 48
    jwt_secret: null

    # Captcha provider: hcaptcha, recaptcha, turnstile
    provider: "hcaptcha"

    # Captcha token TTL in seconds
    token_ttl: 7200

    # Captcha validation cache TTL in seconds
    cache_ttl: 300

# Content Scanning
content_scanning:
  # Enable or disable content scanning
  enabled: false

  # ClamAV server address
  clamav_server: "localhost:3310"

  # Maximum file size to scan in bytes (10MB)
  max_file_size: 10485760

  # Content types to scan (empty means scan all)
  scan_content_types:
    - "text/html"
    - "application/x-www-form-urlencoded"
    - "multipart/form-data"
    - "application/json"
    - "text/plain"

  # Skip scanning for specific file extensions
  skip_extensions: []

  # Wirefilter expression to determine when to scan content
  # Default: scan POST and PUT requests
  # Examples:
  #   - "http.request.method eq \"POST\" or http.request.method eq \"PUT\""
  #   - "http.request.method eq \"POST\" and http.request.path contains \"/upload\""
  #   - "http.request.content_type contains \"multipart/form-data\""
  scan_expression: "http.request.method eq \"POST\" or http.request.method eq \"PUT\""

# Logging Configuration
logging:
  # Log level: error, warn, info, debug, trace
  level: "info"

# BPF Statistics Configuration
bpf_stats:
  # Enable BPF statistics collection
  enabled: true

  # Log statistics every N seconds
  log_interval_secs: 60

  # Enable separate dropped IP events logging
  enable_dropped_ip_events: true

  # Log dropped IP events every N seconds (separate from general stats)
  dropped_ip_events_interval_secs: 30

# TCP Fingerprinting Configuration
tcp_fingerprint:
  # Enable TCP fingerprinting
  enabled: true

  # Log TCP fingerprinting statistics every N seconds
  log_interval_secs: 60

  # Enable separate TCP fingerprint events logging
  enable_fingerprint_events: true

  # Log TCP fingerprint events every N seconds (separate from general stats)
  fingerprint_events_interval_secs: 30

  # Minimum packet count to include in events (reduces noise from single-packet scans)
  min_packet_count: 3

  # Minimum connection duration in seconds to include in events
  min_connection_duration_secs: 1

# Daemon Configuration
daemon:
  # Enable daemon mode (run as background process)
  enabled: false

  # PID file path
  pid_file: "/var/run/moat.pid"

  # Working directory for daemon
  working_directory: "/"

  # Stdout log file (application logs: info, debug, warn, error)
  stdout: "/var/log/moat/access.log"

  # Stderr log file (panic messages and system errors)
  stderr: "/var/log/moat/error.log"

  # User to run daemon as (optional, e.g., "nobody")
  user: null

  # Group to run daemon as (optional, e.g., "daemon")
  group: null

  # Change ownership of PID file to daemon user/group
  chown_pid_file: true

